name: Update Dependencies

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-dep:
    name: Bump Dependencies PR
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v3

      - name: Bump nuget package version
        id: update-csproj
        run: |
          $jdata = curl --silent "https://api.github.com/repos/ppy/osu/releases/latest" | ConvertFrom-Json
          $latestVer = $jdata.tag_name
          $valid = ![string]::IsNullOrWhiteSpace($latestVer)
          if($valid) 
          {
              echo $latestVer
              $regex = '(?<=\"ppy\.osu\.Game.*\"\s*Version\s*=\s*\")(.*)(?=\")'
              (Get-Content osu.Game.Rulesets.Diva\osu.Game.Rulesets.Diva.csproj) -replace $regex, $latestVer | Set-Content osu.Game.Rulesets.Diva\osu.Game.Rulesets.Diva.csproj
              echo "osuVersion=$latestVer" >> $GITHUB_ENV
          }
          echo "versionValid=$valid" >> $GITHUB_ENV

      - run: git --no-pager diff

      - name: Create PR
        if: ${{ env.versionValid }}
        uses: peter-evans/create-pull-request@v4.2.3
        with:
          token: ${{ secrets.PAT }}
          branch: osu-bump-${{ steps.update-csproj.outputs.version }}
          commit-message: 'chore: update osu packages to ${{ steps.update-csproj.outputs.version }}'
          title: 'Update to osu! ${{ env.osuVersion }}'
          base: master
          body: |
            #skip-changelog

            Auto-generated by [create-pull-request](https://github.com/peter-evans/create-pull-request)
          labels: dependencies
          delete-branch: true
